<!DOCTYPE html>
<html lang="en">
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <title>Trip Planner</title>
    <meta charset="UTF-8">
    <link rel="stylesheet" type="text/css" href="css/dc.css">
    <link rel="stylesheet" type="text/css" href="css/leaflet.css">
    <link rel="stylesheet" type="text/css" href="css/bootstrap.css">
    <link rel="stylesheet" type="text/css" href="css/main.css">
    <!-- Hotjar Tracking Code for borhyne.com -->
<script>
    (function(h,o,t,j,a,r){
        h.hj=h.hj||function(){(h.hj.q=h.hj.q||[]).push(arguments)};
        h._hjSettings={hjid:353217,hjsv:5};
        a=o.getElementsByTagName('head')[0];
        r=o.createElement('script');r.async=1;
        r.src=t+h._hjSettings.hjid+j+h._hjSettings.hjsv;
        a.appendChild(r);
    })(window,document,'//static.hotjar.com/c/hotjar-','.js?sv=');
</script>
</head>
<body>
<div class="container-fluid">
  <div class="row">
    <div class="col-xs-12 dc-data-count dc-chart" id="data-count">
      <h2>Portland Trip
        <small>
          <span class="filter-count"></span> selected out of <span class="total-count"></span> places |
           <a id="all" href="#">Start Over</a>
          </span>
        </small>
      </h2>
    </div>
  </div>
  <div class="row" id="control-row">
    
    <div class="col-md-6">
      <h4><a href="/form.html">Click here to add points</a></h4>
      <div id="map" style="width: 100%; height: 300px"></div>
    </div>


    <div class="col-xs-6 col-md-3">
      <div class="dc-chart" id="chart-NumReviews"></div>
    </div>
    <div class="col-xs-6 col-md-3">
      <div class="dc-chart" id="chart-PopDensity"></div>
    </div>
    <div class="col-xs-6 col-md-3">
      <div class="dc-chart" id="chart-MedianIncome"></div>
    </div>

    

  </div>

  <div class="row">
    <div class="col-xs-12">
      <table id="data-table" class="display table table-bordered table-striped" cellspacing="0" width="100%">
        <thead>
          <tr class="header">
            <th>Name of Place</th>
            <th>Vote Count</th>
            <th>Why to visit</th>
            <th>Hours?</th>
            <th>Cost?</th>
            <th>Link to more info</th>
          </tr>
        </thead>
        <tfoot>
          <tr class="header">
            <th>Name of Place</th>
            <th>Vote Count</th>
            <th>Why to visit</th>
            <th>Hours?</th>
            <th>Cost?</th>
            <th>Link to more info</th>
          </tr>
        </tfoot>
      </table>
    </div>

  </div>
  <div class="row">
  <a href="https://docs.google.com/spreadsheets/d/138dId0hhjY3rgnRI0rULEEhO8DM-LcLJ8MDM5CPTfgs/edit#gid=0">Click here to update votes</a>
  <iframe src="https://docs.google.com/spreadsheets/d/138dId0hhjY3rgnRI0rULEEhO8DM-LcLJ8MDM5CPTfgs/pubhtml?gid=0&amp;single=true&amp;widget=true&amp;headers=false" width="100%" height="200"></iframe>
  <iframe src="https://docs.google.com/forms/d/e/1FAIpQLSf1OBHjZodEi80IFsGcF4HRQNXRAaBLi7K7mP7znMQaV3IYNw/viewform?embedded=true" width="100%" height="400" frameborder="0" marginheight="0" marginwidth="0"></iframe>  
  </div>
</div>
<script type="text/javascript" src="js/d3.js"></script>
<script type="text/javascript" src="js/crossfilter.js"></script>
<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/dc/2.1.0-dev/dc.js"></script>
<script type="text/javascript" src="https://code.jquery.com/jquery-3.1.1.min.js"></script>
<script type="text/javascript" src="js/tabletop.js"></script>
<!--js/dc.js-->
<script type="text/javascript" src="js/leaflet.js"></script>
<script type="text/javascript" src="js/underscore-min.js"></script>

<script type="text/javascript" >

/* instantiate and configure map */
var map = L.map('map');
var breweryMarkers = new L.FeatureGroup();

L.tileLayer('https://api.mapbox.com/styles/v1/mapbox/streets-v10/tiles/256/{z}/{x}/{y}?access_token=pk.eyJ1IjoiYm9yaHluZSIsImEiOiJjaXZyOWxjM2kwM3RuMnp0ODFmazg5NGhzIn0.-nn9OxmxJ03rHNtZlCNUWw', {
  //maxZoom: 16
} ).addTo(map);

var public_spreadsheet_url = 'https://docs.google.com/spreadsheets/d/1ebVZAzUPaU_4l5OD7E1ABXFK5H7mPf8FY4HcMWtlMQ8/pubhtml';

function renderSpreadsheetData() {
    Tabletop.init( { key: public_spreadsheet_url,
                     callback: draw,
                     simpleSheet: true } )
}







function draw(data, tabletop) {
//d3.csv('brewerydata.csv', function(error, data) {  
  var beerData = data;

  var fullDateFormat = d3.time.format('%a, %d %b %Y %X %Z');
  var yearFormat = d3.time.format('%Y');
  var monthFormat = d3.time.format('%b');
  var dayOfWeekFormat = d3.time.format('%a');

_.each(beerData, function(d) {
  d.count = +d.count;
  d.MedianIncome = Math.round(+d.MedianIncome);
  d.PopDensity = Math.round(+d.PopDensity);
  });     

  // set crossfilter
  var ndx = crossfilter(beerData);

  // create dimensions (x-axis values)
  var NumReviewsDim = ndx.dimension(function(d) {return d.NumReviews;}),
      miDim = ndx.dimension(function(d) {return d.MedianIncome;}),
      PDDim = ndx.dimension(function(d) {return d.PopDensity;}),
      allDim = ndx.dimension(function(d) {return d;});

  // create groups (y-axis values)
  var all = ndx.groupAll();
  var countPerNumReviews = NumReviewsDim.group().reduceCount(),
      countPerPD = PDDim.group().reduceCount(),
      countPerMI = miDim.group().reduceCount();

  // specify charts
  var numreviewsChart  = dc.barChart('#chart-NumReviews'),
      popdensityChart  = dc.barChart('#chart-PopDensity'),
      medianincomeChart = dc.barChart('#chart-MedianIncome'),
      dataCount = dc.dataCount('#data-count')
      dataTable = dc.dataTable('#data-table');

  numreviewsChart
      .width(300)
      .height(180)
      .dimension(NumReviewsDim)
      .group(countPerNumReviews)
      .x(d3.scale.linear().domain([-9, d3.max(beerData, function (d) { return d.NumReviews; })*1.1]))
      .elasticY(true)
      .centerBar(true)
      .xUnits(function(){return 10;})
      .barPadding(2)
      .xAxisLabel('Total Vote (8 = great, -8 = terrible)')
      .yAxisLabel('Count')
      .margins({top: 10, right: 20, bottom: 50, left: 50});

  popdensityChart
      .width(300)
      .height(180)
      .dimension(PDDim)
      .group(countPerPD)
      .x(d3.scale.linear().domain([-0.5, d3.max(beerData, function (d) { return d.PopDensity; })*1.1]))
      .xUnits(function(){return 10;})
      .barPadding(2)
      .elasticY(true)
      .centerBar(true)
      .xAxisLabel('Activity Length (hours)')
      .yAxisLabel('Count')
      .margins({top: 10, right: 20, bottom: 50, left: 50});

  medianincomeChart
      .width(300)
      .height(180)
      .dimension(miDim)
      .group(countPerMI)
      .x(d3.scale.linear().domain([-5, d3.max(beerData, function (d) { return d.MedianIncome; }) + 5]))
      .elasticY(true)
      .centerBar(true)
      .xUnits(function(){return 10;})
      .barPadding(2)
      .xAxisLabel('Activity Cost ($)')
      .yAxisLabel('Count')
      //.xUnits(function (d) { return 5;})
      .margins({top: 10, right: 20, bottom: 50, left: 50});

  dataCount
      .dimension(ndx)
      .group(all);

   dataTable
    .dimension(allDim)
    .group(function (d) { return 'dc.js insists on putting a row here so I remove it using JS'; })
    .columns([
      function (d) { return d.Brewery; },
      function (d) { return d.NumReviews; },
      function (d) { return d.Address; },
      function (d) { return d.PopDensity; },
      function (d) { return d.MedianIncome; },
      function (d) { return d.YelpRating; }
    ])
    .sortBy(function (d) { return d.NumReviews; })
    .order(d3.descending)
    .size(Infinity)
    .on('renderlet', function (table) {
      // each time table is rendered remove nasty extra row dc.js insists on adding
      table.select('tr.dc-table-group').remove();

      // update map with breweries to match filtered data
      breweryMarkers.clearLayers();
      _.each(allDim.top(100), function (d) {
        var loc = d.Address;
        var name = d.Brewery;
        var marker = L.marker([d.lat, d.lng]);
        marker.bindPopup("<p>" + name + "</br>" + loc + "</p>");
        breweryMarkers.addLayer(marker);
      });
      map.addLayer(breweryMarkers);
      map.fitBounds(breweryMarkers.getBounds());
    });

  // register handlers
  d3.selectAll('a#all').on('click', function () {
    dc.filterAll();
    dc.renderAll();
  });

  // showtime!
  dc.renderAll();
}

renderSpreadsheetData();



</script>
</body></html>